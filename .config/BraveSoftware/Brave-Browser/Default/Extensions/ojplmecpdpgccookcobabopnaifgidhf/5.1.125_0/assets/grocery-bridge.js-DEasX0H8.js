import{c as ee,y as gt,z as yt}from"./utility_all2-0mYDd1Oa.js";let ze=!1,Me=!1,N,lt="",D={},A={},pe,Fe={},Ye=null,Ne=0,bt=2*60*1e3,it=5*60*1e3,ye=new Map,ie=new Map,Ce=5*60*1e3;function st(){let t=Date.now();for(let[e,r]of ye.entries())r.ts&&t-r.ts>=it&&ye.delete(e)}function nt(){let t=Date.now();for(let[e,r]of ie.entries())r.timestamp&&t-r.timestamp>=Ce&&ie.delete(e)}setInterval(()=>{st(),nt()},10*60*1e3);function B(t){return new Promise((e,r)=>{chrome.runtime.sendMessage(t,n=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):e(n)})})}function T(t,e,r=null){window.dispatchEvent(new CustomEvent("FROM_EXTENSION_RESPONSE",{detail:{type:t,data:e,error:r}}))}let re={};async function St(){let t=[],e=re.clusters;if(!e)return;let r=Math.min(3,e.length);for(let l=0;l<r;l++){let i=e[l];if(!i)continue;let o=-1,d="",s=[],a=[],u=new Map;for(let c in i)if(c!=="_clusterMeta"&&Array.isArray(i[c])){let g=i[c];a.push(...g);let m=g.length;m>o&&(o=m,d=c,s=g)}if(d){s.forEach(m=>{u.set(m.pid,m)}),a.filter(m=>m.source==="zepto").forEach(m=>{m.isEnriched=!0,u.set(m.pid,m)});let g=Array.from(u.values());t.push({index:l,variant:d,clusters:g})}}await ee({type:"getGroceryPriceConfig"});let n=t.map(l=>{let i={quantity:l.variant,productList:l.clusters,productIndex:l.index};return Re(i)});await Promise.allSettled(n)}async function vt(){let t=re.clusters;if(!t||t.length<=3)return;let e=Math.min(5,t.length),r=[];for(let n=3;n<e;n++){let l=t[n];if(!l)continue;let i=-1,o="",d=[];for(let s in l)if(s!=="_clusterMeta"&&Array.isArray(l[s])){let a=l[s].length;a>i&&(i=a,o=s,d=l[s])}if(o){let s=d.filter(a=>a.source==="zepto");if(s.length>0){s.forEach(u=>{u.isEnriched=!0});let a={quantity:o,productList:s,productIndex:n};r.push(Re(a))}}}await Promise.allSettled(r)}async function he(t){var n;re=t||{};let e=re.responseReceived??re.responsesReceived,r=re.totalResponse??re.totalRequests;(n=re==null?void 0:re.clusters)!=null&&n.clusters&&Array.isArray(re.clusters.clusters)&&(re.clusters=re.clusters.clusters),Array.isArray(re.clusters)&&e>=r&&(await St(),await ee({type:"fireEvent",eventName:"grocerySearchComplete",params:{success:!0}}),T("CLUSTER_DATA",re),await vt())}async function It(t,e=0,r=!1,n=null,l=!1){if(ze)return;ze=!0,D=(await chrome.storage.local.get("userLocation")).userLocation;let o=N;try{let d=await B({action:"fetchBlinkitSearch",query:t,latitude:D==null?void 0:D.latitude,longitude:D==null?void 0:D.longitude,offset:e,sessionRequestId:n,isNewSearch:l,onlyForSuggestion:!1});if(o!==N)return;if(d.success){if(d.clusters){if(o!==N)return;pe=d.clusters}if(T("BLINKIT_PRODUCTS",d.products),d.clusters){if(o!==N)return;let s={clusters:d.clusters,isSearchSessionComplete:d.isSearchSessionComplete,type:d.type,responseReceived:d.responsesReceived,totalResponse:d.totalRequests};T("CLUSTER_DATA",d),he(d)}}}catch{}finally{ze=!1}}async function wt(t,e=null,r=!1){let n=N;try{let l=await B({action:"fetchBigBasketSearch",query:t,sessionRequestId:e,isNewSearch:r,onlyForSuggestion:!1});if(n!==N)return;if(l.success){if(T("BIGBASKET_PRODUCTS",l.products),l.clusters){if(n!==N||(pe=l.clusters,n!==N))return;let i={clusters:l.clusters,isSearchSessionComplete:l.isSearchSessionComplete,type:l.type,responseReceived:l.responsesReceived,totalResponse:l.totalRequests};T("CLUSTER_DATA",l),he(l)}}else T("BIGBASKET_PRODUCTS",[])}catch{T("BIGBASKET_PRODUCTS",[])}}async function Tt(t,e=null,r=!1){let n=N;D=(await chrome.storage.local.get("userLocation")).userLocation;try{let i=await B({action:"fetchInstamartSearch",query:t,latitude:D==null?void 0:D.latitude,longitude:D==null?void 0:D.longitude,sessionRequestId:e,isNewSearch:r,onlyForSuggestion:!1});if(n!==N)return;if(i.success){if(T("INSTAMART_PRODUCTS",i.products),i.clusters){if(n!==N||(pe=i.clusters,n!==N))return;let o={clusters:i.clusters,isSearchSessionComplete:i.isSearchSessionComplete,type:i.type,responseReceived:i.responsesReceived,totalResponse:i.totalRequests};T("CLUSTER_DATA",i),he(i)}}else T("INSTAMART_PRODUCTS",[])}catch{T("INSTAMART_PRODUCTS",[])}}async function _t(t,e=null,r=!1){let n=N;try{let l=await B({action:"fetchJioMartSearch",query:t,sessionRequestId:e,isNewSearch:r,onlyForSuggestion:!1});if(n!==N)return;if(l.success){if(T("JIOMART_PRODUCTS",l.products),l.clusters){if(n!==N||(pe=l.clusters,n!==N))return;let i={clusters:l.clusters,isSearchSessionComplete:l.isSearchSessionComplete,type:l.type,responseReceived:l.responsesReceived,totalResponse:l.totalRequests};T("CLUSTER_DATA",l),he(l)}}else T("JIOMART_PRODUCTS",[])}catch{T("JIOMART_PRODUCTS",[])}}async function Et(t,e=null,r=!1,n=!1){if(!n){if(Me)return;Me=!0}let l=N;try{let i=await B({action:"fetchFlipkartMinutes",query:n?t:lt,sessionRequestId:e,isNewSearch:r,onlyForSuggestion:n});if(l!==N)return;if(i.success){if(i.clusters){if(l!==N)return;pe=i.clusters}if(T("FLIPKART_PRODUCTS",i.products),i.clusters){if(l!==N)return;let o={clusters:i.clusters,isSearchSessionComplete:i.isSearchSessionComplete,type:i.type,responseReceived:i.responsesReceived,totalResponse:i.totalRequests};T("CLUSTER_DATA",i),he(i)}}else T("FLIPKART_PRODUCTS",[])}catch{T("FLIPKART_PRODUCTS",[])}finally{n||(Me=!1)}}async function Ct(t,e=null,r=!1){let n=N;try{let l=await B({action:"fetchAmazonSearch",query:t,sessionRequestId:e,isNewSearch:r,onlyForSuggestion:!1});if(n!==N)return;if(l.success){if(T("AMAZON_PRODUCTS",l.products),l.clusters){if(n!==N||(pe=l.clusters,n!==N))return;let i={clusters:l.clusters,isSearchSessionComplete:l.isSearchSessionComplete,type:l.type,responseReceived:l.responsesReceived,totalResponse:l.totalRequests};T("CLUSTER_DATA",l),he(l)}}else T("AMAZON_PRODUCTS",[])}catch{T("AMAZON_PRODUCTS",[])}}async function At(t,e=null,r=!1){let n=N;try{let l=await B({action:"fetchZeptoSearch",query:t,sessionRequestId:e,isNewSearch:r,onlyForSuggestion:!1});if(n!==N)return;if(l.success){if(l.clusters){if(n!==N)return;pe=l.clusters}if(T("ZEPTO_PRODUCTS",l.products),l.clusters){if(n!==N)return;let i={clusters:l.clusters,isSearchSessionComplete:l.isSearchSessionComplete,type:l.type,responseReceived:l.responsesReceived,totalResponse:l.totalRequests};T("CLUSTER_DATA",l),he(l)}}else T("ZEPTO_PRODUCTS",[])}catch{T("ZEPTO_PRODUCTS",[])}}async function Rt(t,e=null,r=!1){let n=N;try{let l=await B({action:"fetchDMartSearch",query:t,sessionRequestId:e,isNewSearch:r,onlyForSuggestion:!1});if(n!==N)return;if(l.success){if(T("DMART_PRODUCTS",l.products),l.clusters){if(n!==N||(pe=l.clusters.clusters,n!==N))return;let i={clusters:l.clusters,isSearchSessionComplete:l.isSearchSessionComplete,type:l.type,responseReceived:l.responsesReceived,totalResponse:l.totalRequests};T("CLUSTER_DATA",l),he(l)}}else T("DMART_PRODUCTS",[])}catch{T("DMART_PRODUCTS",[])}}async function kt(t){try{ot({lat:t.lat,lng:t.lng},null),await B({action:"storeLocation",latitude:t.lat,longitude:t.lng});try{let e=await B({action:"getAddress",lat:t.lat,lon:t.lng});if(e&&e.success){let r=e.address;T("LOCATION_UPDATED",{address:r,latitude:t.lat,longitude:t.lng});try{await Se()}catch{}}else throw new Error((e==null?void 0:e.error)||"Unknown error fetching address")}catch(e){T("LOCATION_UPDATED",{address:"Could not find address",latitude:D.latitude,longitude:D.longitude},e.message);try{await Se()}catch{}}}catch{T("LOCATION_UPDATED",null,"Failed to store location. Please try again.")}}async function Pt(t){try{let e=await B({action:"fetchSuggestions",query:t});e.success&&e.suggestions?T("SUGGESTIONS_RESULT",e):T("SUGGESTIONS_RESULT",[],e.error)}catch(e){T("SUGGESTIONS_RESULT",[],e.message)}}async function Ot(t){try{let e=await B({action:"fetchAddressSuggestions",query:t});e.success&&e.suggestions?T("ADDRESS_SUGGESTIONS_RESULT",e.suggestions):T("ADDRESS_SUGGESTIONS_RESULT",[],e.error)}catch(e){T("ADDRESS_SUGGESTIONS_RESULT",[],e.message)}}async function ot(t,e=null){try{let r;if(e!=null?r=e:r=(await chrome.storage.local.get("userLocation")).userLocation,!r)return T("WITHIN_500M",!1),!1;let n=r.latitude,l=r.longitude,i=t.lat,o=t.lng,d=6371e3,s=b=>b*Math.PI/180,a=s(i-n),u=s(o-l),c=Math.sin(a/2)**2+Math.cos(s(n))*Math.cos(s(i))*Math.sin(u/2)**2,g=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)),f=d*g<=500;return T("WITHIN_500M",f),f}catch{return T("WITHIN_500M",!1),!1}}async function qe(t){var e;try{let r=await B({action:"fetchBlinkitETA",latitude:t.latitude,longitude:t.longitude});if(r.success&&((e=r.data)!=null&&e.eta_in_minutes)){let n=r.data.eta_in_minutes+" mins";A.blinkit={eta:n,connected:!0}}else r.data.status_code=="Temporary Unavailable"?A.blinkit={eta:"Closed",connected:!1}:A.blinkit={eta:null,connected:!1}}catch{A.blinkit={eta:null,connected:!1}}}async function Be(t){try{let e=await B({action:"fetchInstamartETA",latitude:t.latitude,longitude:t.longitude});if(e&&e.success&&e.data&&e.data.eta){let r=e.data.eta,n=r.unit.toLowerCase(),l=`${r.value} ${n}`;A.instamart={eta:l,connected:!0}}else A.instamart={eta:null,connected:!1}}catch{A.instamart={eta:null,connected:!1}}}async function Ke(t){try{let e=await B({action:"fetchBBNOWEta",latitude:t.latitude,longitude:t.longitude});e==="BB_NOT_DELIVERABLE"?A.bigbasket={eta:null,connected:!1}:e&&e.success&&e.data?A.bigbasket={eta:e.data,connected:!0}:A.bigbasket={eta:null,connected:!1}}catch{A.bigbasket={eta:null,connected:!1}}}async function $e(t){try{let e=await B({action:"fetchDmartEta",latitude:t.latitude,longitude:t.longitude});if(e&&e.success&&e.data)if(e.data.timeSlot){let r=e.data.timeSlot,n=r.match(/(\w+)\s+(.+)/);if(n){let l=n[1],o=n[2].replace(/(\d+):00\s*/g,"$1").replace(/\s*-\s*/g,"-").replace(/\s+/g,"");A.dmart={eta:`${l.slice(0,3)} ${o}`,connected:!0}}else A.dmart={eta:r,connected:!0}}else A.dmart={eta:null,connected:!1};else A.dmart={eta:null,connected:!1}}catch{A.dmart={eta:null,connected:!1}}}async function je(t){try{let e=await B({action:"fetchFlipkartMinutesETA",latitude:t.latitude,longitude:t.longitude});e==="FLIPKART_MINUTES_ETA_NOT_FOUND"?A.flipkart={eta:null,connected:!1}:e&&e.success&&e.data?A.flipkart={eta:e.data,connected:!0}:A.flipkart={eta:null,connected:!1}}catch{A.flipkart={eta:null,connected:!1}}}async function Ve(t){try{let e=await B({action:"fetchJioMartETA",latitude:t.latitude,longitude:t.longitude});e&&e.success&&e.data?e.data.eta?A.jiomart={eta:e.data.eta,connected:!0}:A.jiomart={eta:null,connected:!1}:A.jiomart={eta:null,connected:!1}}catch(e){throw A.jiomart={eta:null,connected:!1},e}}async function xe(t){var e,r,n,l,i;try{let o=await B({action:"fetchZeptoStoreInfo",latitude:t.latitude,longitude:t.longitude});if(o.success&&((r=(e=o.data)==null?void 0:e.storeServiceableResponse)!=null&&r.storeId)){let d=o.data.storeServiceableResponse.storeId,s=await B({action:"fetchZeptoETA",storeId:d,latitude:t.latitude,longitude:t.longitude,userId:""});if(s.success&&((n=s.data)!=null&&n.secondaryText))A.zepto={eta:s.data.secondaryText,connected:!0},A.zepto.eta=String(A.zepto.eta).replace(/\bminutes\b/gi,"mins").replace(/\bminute\b/gi,"min");else if(s.data.deliverableType=="CLOSED")A.zepto={eta:"Closed",connected:!1};else if(s.success)A.zepto={eta:null,connected:!1};else if(A.zepto={eta:null,connected:!1},s.error&&s.error.includes("ZEPTO_LOGIN_REQUIRED"))throw new Error("ZEPTO_LOGIN_REQUIRED")}else((l=o==null?void 0:o.data)==null?void 0:l.error)==="ZEPTO_LOGIN_REQUIRED"?A.zepto={eta:null,connected:!1,loginUrl:(i=o==null?void 0:o.data)==null?void 0:i.login_url}:A.zepto={eta:null,connected:!1}}catch(o){if(A.zepto={eta:null,connected:!1},o.message==="ZEPTO_LOGIN_REQUIRED")throw showZeptoLoginModal(),o}}async function Ge(t,e=!1){var n;let r;try{r=await B({action:"fetchAmazonAddresses"});let l=(n=r==null?void 0:r.data)==null?void 0:n.addressList;if((l==null?void 0:l.error)==="AMAZON_LOGIN_REQUIRED")throw A.amazon={eta:null,connected:!1,loginUrl:l.login_url},new Error("AMAZON_LOGIN_REQUIRED");if(!Array.isArray(l)||l.length===0)throw new Error("No Amazon addresses available");let i=l,o=null;if(e)try{let d=await chrome.storage.local.get("amazonSelectedAddressId");o=(d==null?void 0:d.amazonSelectedAddressId)||null}catch{}else if(t&&(o=Kt(i,t),o&&o!=="NO_ADDRESS_MATCH"))try{await chrome.storage.local.set({amazonSelectedAddressId:o})}catch{}if(!o||o==="NO_ADDRESS_MATCH")A.amazon={eta:null,connected:!1,addresses:i};else{let d=await ct(o);try{let s=typeof d=="string"?d.toLowerCase():"";/\b(opens\s*at|reopen|reopens)\b/.test(s)&&Promise.resolve().then(()=>{A&&A.amazon&&(A.amazon.connected=!1,A.amazon.eta=d)})}catch{}d?A.amazon={eta:d,connected:!0}:A.amazon={eta:null,connected:!1,addresses:i}}}catch(l){l.message!=="AMAZON_LOGIN_REQUIRED"&&(A.amazon={eta:null,connected:!1,addresses:null,error:l.message})}}async function ct(t){if(!t)return null;try{let e=await B({action:"fetchAmazonETA",addressId:t});if(e&&e.success&&e.data&&e.data.etaText)return e.data.etaText}catch(e){throw e}}let Ze={blinkit:qe,instamart:Be,bigbasket:Ke,dmart:$e,flipkart:je,jiomart:Ve,zepto:xe,amazon:Ge},de={};function zt(t,e,r){de[t]=0;let n=setInterval(async()=>{if(de[t]++,await e(r),A[t]&&A[t].connected){clearInterval(n),delete de[t];for(let l in de)de[l]=0;Pe(A),T("ETA_DELIVERY_TIME",A)}de[t]>=20&&(clearInterval(n),delete de[t])},5e3)}async function Se(t=!1,e=!1){try{D=(await chrome.storage.local.get("userLocation")).userLocation;let n=JSON.stringify({lat:D&&D.latitude,lon:D&&D.longitude});if(t&&n&&n===Ye&&Ne&&Date.now()-Ne<bt&&A&&Object.keys(A).length||(await ee({type:"getPlatformETAConfig"}),await Promise.all([qe(D),Be(D),Ke(D),$e(D),je(D),Ve(D),xe(D),Ge(D,e)]),ee({type:"sendStoreData"}),Ye=n,Ne=Date.now(),t))return A;Pe(A),T("ETA_DELIVERY_TIME",A);for(let l in A){let i=A[l];!i.connected&&i.loginUrl&&Ze[l]&&de[l]===void 0&&zt(l,Ze[l],D)}}catch{}}let Ae={};async function Pe(t){let e={blinkit:"Blinkit",instamart:"Instamart",bigbasket:"BigBasket",dmart:"DMart",flipkart:"Flipkart Minutes",jiomart:"JioMart",zepto:"Zepto",amazon:"Amazon"},r=await chrome.storage.local.get("platformConnections");r.platformConnections&&(Ae=r.platformConnections);for(let[n,l]of Object.entries(e)){let i=t[n];if(!i)continue;let o=(typeof i.eta=="string"?i.eta:"").trim().toLowerCase(),d=!!o&&(/\b(closed|reopen|reopens|opens\s*at)\b/.test(o)||n==="amazon"&&o.startsWith("opens at")),s=i.connected===!0&&i.eta!==null&&!d;Ae[l]={closed:!s,connected:s,connecting:!1}}await chrome.storage.local.set({platformConnections:Ae})}async function Mt(t){try{let{userLocation:e}=await chrome.storage.local.get("userLocation"),r=await B({action:"fetchAddressInfoManual",address:t}),n={lat:r.suggestions.location.lat,lng:r.suggestions.location.long};if(ot(n,e),r.success&&r.suggestions&&r.suggestions.location){let l=r.suggestions.location;e={address:l.address,latitude:parseFloat(l.lat),longitude:parseFloat(l.long),pincode:l.pincode,timestamp:Date.now()};try{await chrome.storage.local.set({userLocation:e}),await Se()}catch{}T("ADDRESS_INFO_RESULT",l)}else{let l=r.error||"Could not find location info.";T("ADDRESS_INFO_RESULT",null,l)}}catch(e){T("ADDRESS_INFO_RESULT",null,e.message||"An unknown error occurred.")}}function ue(t){if(!t)return null;if(typeof t=="number")return t;let e=String(t).replace(/[^0-9.]/g,"");if(!e)return null;let r=Number(e);return Number.isFinite(r)?r:null}function Ie(t){if(t==null||t===void 0||t==="")return!0;let e=typeof t=="number"?t:ue(t);return e==null||!Number.isFinite(e)||e<=0}let Te={blinkit:0,instamart:1,zepto:2,jiomart:3,bigbasket:4,flipkart:5,flipkart_minutes:5,amazon:6,amazon_fresh:6,dmart:7},Nt={0:7740,1:25622,2:7907,3:25850,4:2268,5:25848,6:25847,7:7006},Ue=Object.fromEntries(Object.entries(Te).map(([t,e])=>[String(e),t]));async function Re(t){let{quantity:e,productList:r,productIndex:n}=t;try{let l=e,o=(r||[]).filter(m=>{if(!(m.isEnriched===!0||m.productType==="cross-platform"||m.productType==="same-platform"))return!1;if(m.source==="zepto"&&m.pricesFetched===!0){let b=m.price||m.priceSALE||m.sellingPrice||0;if(!(Ie(b)||m.oos===1||m.stock===0||m.stockStatus==="Out of Stock"||m.discontinued))return!1}return!0});if(o=o.sort((m,f)=>{let b=m.price||m.priceSALE||m.sellingPrice||0,y=f.price||f.priceSALE||f.sellingPrice||0,p=Ie(b)||m.oos===1||m.stock===0||m.stockStatus==="Out of Stock"||m.discontinued,h=Ie(y)||f.oos===1||f.stock===0||f.stockStatus==="Out of Stock"||f.discontinued;return p!==h?p?1:-1:0}),o.length===0){(r||[]).forEach(f=>{(f.isEnriched===!0||f.productType==="cross-platform"||f.productType==="same-platform")&&(f.pricesFetched=!0)});return}let d={};o.forEach(m=>{d[m.source]||(d[m.source]=[]),d[m.source].push(m)});let s=Object.entries(d).map(([m,f])=>Ut(m,f,n,l)),a=await Promise.allSettled(s),u=0,c=0;a.forEach((m,f)=>{let b=Object.keys(d)[f];m.status==="fulfilled"?u+=m.value.updatedCount||0:c++}),(r||[]).forEach(m=>{(m.isEnriched===!0||m.productType==="cross-platform"||m.productType==="same-platform")&&(m.pricesFetched=!0)}),u>0&&T("PRICE_UPDATE_RESULT",{productIndex:n,productList:r,quantity:e})}catch{}}let Lt=[];async function Ft(t,e,r,n){Lt.push(...n);try{let l=await chrome.storage.local.get("allStoresId"),i=(l==null?void 0:l.allStoresId)||{},o=a=>{let u=q((a==null?void 0:a.source)||(a==null?void 0:a.platform)||r);switch(u){case"flipkart":case"flipkart_minutes":return"flipkart_minutes";case"amazon":case"amazon_fresh":return i.hasOwnProperty("amazon_now")?"amazon_now":"amazon_fresh";case"bigbasket":return"bigbasket";case"blinkit":return"blinkit";case"instamart":return"instamart";case"jiomart":return"jiomart";case"dmart":return"dmart";case"zepto":return"zepto";default:return u}},d={},s=(n||[]).map(a=>{let u=a==null?void 0:a.storeId;if(!u||u==="null"||u==="undefined"){let b=o(a),y=i==null?void 0:i[b];y!=null&&(u=y,a.storeId=y)}let c=q((a==null?void 0:a.source)||(a==null?void 0:a.platform)||r),g=Te[c],m=Nt[g],f={storeId:u,mrp:a==null?void 0:a.mrp,image:a==null?void 0:a.imageUrl,quantity:(a==null?void 0:a.weight)||(a==null?void 0:a.variant)||"",price:a==null?void 0:a.price,pid:a==null?void 0:a.pid,prod:a==null?void 0:a.productName,oos:(a==null?void 0:a.availability)||0,qCom:1};return m&&(d[m]||(d[m]=[]),d[m].push(f)),f});for(let[a,u]of Object.entries(d))if(Array.isArray(u)&&u.length>0&&a)try{let g=[{pairsGeneralise:{data:JSON.stringify(u),actPos:Number(a)}}],m=JSON.stringify(g);gt(0,m,0,yt,[])}catch{}}catch{}}async function Ut(t,e,r,n){let l={updatedCount:0,errors:[]};try{let i=5;for(let o=0;o<e.length;o+=i){let d=e.slice(o,o+i),s=d.map(async a=>{try{let u=await B({action:"fetchPrice",pid:a.pid,platform:a.source,variant:a.variant||1});if(u.success&&u.data){let c=u.data;Array.isArray(c)&&c.length>0&&(c=c[0]),u&&a.source=="instamart"&&(a.spinId=c.spinId||null,a.itemId=c.itemId||null),u&&a.source=="flipkart_minutes"&&(a.itemId=c.listingId||null,a.storeId=c.storeId||null),u&&(a.source=="amazon"||a.source=="amazon_fresh"||a.source=="amazonNow")&&(c=="IS_FRESH_PID"&&(a.oos=1),a.offerId=c.offerId||null),Dt(a,c,t),c&&(c.oos===1||c.discontinued||(c.price==null||Number(c.price)<=0)&&c.oos!==0)?(a.oos=c.oos||1,c.discontinued&&(a.discontinued=!0),a.lastPriceUpdate=Date.now(),a.isEnriched=!1,a.revealedForSmartCart=!0,a.pricesFetchedSmartCart=!0,a.lastSmartCartFetch=Date.now(),l.updatedCount++):c&&c.price&&c.price>0&&(a.price=c.price,c.mrp&&(a.mrp=c.mrp),c.hasOwnProperty("oos")&&(a.oos=c.oos),a.discontinued&&delete a.discontinued,a.lastPriceUpdate=Date.now(),a.isEnriched=!1,a.revealedForSmartCart=!0,a.pricesFetchedSmartCart=!0,a.lastSmartCartFetch=Date.now(),l.updatedCount++)}}catch(u){l.errors.push({pid:a.pid,error:u.message})}});await Promise.allSettled(s),o+i<e.length&&await new Promise(a=>setTimeout(a,200)),d.forEach(a=>{a.pricesFetchedSmartCart||(a.pricesFetchedSmartCart=!0,a.lastSmartCartFetch=Date.now())})}}catch(i){l.errors.push({platform:t,error:i.message})}return Ft(r,n,t,e),l}function Dt(t,e,r){var m,f,b,y,p;if(!t||typeof t!="object"||!e||typeof e!="object")return t;let n=q(r||t.source||t.platform),i=[e.productUrl,e.prodUrl,e.productLink,e.link,e.url,e.canonicalUrl,t.productUrl,t.prodUrl,t.url].find(h=>typeof h=="string"&&h.trim().length>0)||"";i&&(t.productUrl=i,t.prodUrl=t.prodUrl||i,t.url=t.url||i);let d=[e.image,e.imageUrl,e.thumbnail,e.img,e.picture,t.image,t.imageUrl,t.thumbnail].find(h=>typeof h=="string"&&h.trim().length>0);d&&(t.image=t.image||d,t.imageUrl=t.imageUrl||d,t.thumbnail=t.thumbnail||d);let s=e.brand||e.brandName||e.manufacturer;s&&!t.brand&&(t.brand=s);let a=e.variant||e.size||e.weight||e.unit;a&&!t.variant&&(t.variant=a);let u=e.pid||e.PID||e.id||e.productId||e.sku;u&&!t.pid&&(t.pid=u),e.sku&&!t.sku&&(t.sku=e.sku);let c=Bt(e);Number.isFinite(c)&&c>0&&(t.price=Number(c),t.sellingPrice=t.sellingPrice||Number(c),t.discountedPrice=t.discountedPrice||Number(c)),e.mrp&&(!t.mrp||Number(t.mrp)<=0)&&(t.mrp=Number(e.mrp));let g={...t.cartMeta,platform:n||((m=t.cartMeta)==null?void 0:m.platform)||t.source,itemId:e.itemId||e.listingId||((f=t.cartMeta)==null?void 0:f.itemId)||t.itemId,spinId:e.spinId||((b=t.cartMeta)==null?void 0:b.spinId)||t.spinId,offerId:e.offerId||((y=t.cartMeta)==null?void 0:y.offerId)||t.offerId,quantity:e.quantity||((p=t.cartMeta)==null?void 0:p.quantity)||t.quantity,raw:e};return t.cartMeta=g,t.rawPriceResponse=e,n&&(t.source=n,t.platform=n),t}function q(t){if(!t)return null;let e=String(t).trim().toLowerCase();switch(e){case"fk":case"flipkart minutes":case"flipkart_minutes":case"flipkartminutes":case"flipkart":return"flipkart";case"amz":case"amazon fresh":case"amazon_fresh":case"amazon prime now":case"amazonnow":case"amazon":return"amazon";case"big basket":case"bigbasket":case"bb":case"bbnow":return"bigbasket";case"swiggy instamart":case"instamart":return"instamart";case"jio mart":case"jiomart":return"jiomart";case"dmart":return"dmart";case"zepto":return"zepto";case"blinkit":return"blinkit";default:return e.replace(/\s+/g,"")}}function me(t){let e={flipkart:"flipkart_minutes",flipkart_minutes:"flipkart_minutes",amazon:"amazon_fresh",amazon_fresh:"amazon_fresh",bigbasket:"bigbasket",blinkit:"blinkit",instamart:"instamart",jiomart:"jiomart",dmart:"dmart",zepto:"zepto"},r=(t||"").toLowerCase().replace(/\s+/g,"_");return e[r]||r}function qt(t){if(!t||typeof t!="string")return 1/0;let e=t.match(/(\d+)\s*-\s*(\d+)\s*min/i);if(e)return parseInt(e[1],10);let r=t.match(/(\d+)\s*min/i);if(r)return parseInt(r[1],10);let n=t.match(/(\d+)\s*(hr|hrs|hour|hours)/i);return n?parseInt(n[1],10)*60:Number.POSITIVE_INFINITY}function _e(t){let e=[t==null?void 0:t.price,t==null?void 0:t.priceSALE,t==null?void 0:t.sellingPrice,t==null?void 0:t.discountedPrice];for(let r of e){let n=typeof r=="number"?r:ue(r);if(Number.isFinite(n)&&n>0)return n}return null}function ut(t){let e=parseInt(t,10);return Number.isFinite(e)&&e>0?e:1}function ve(t){let e=_e(t),r=(t==null?void 0:t.oos)===1||(t==null?void 0:t.outOfStock)||(t==null?void 0:t.stock)===0||(t==null?void 0:t.stockStatus)==="Out of Stock"||(t==null?void 0:t.discontinued);return!!(e&&e>0&&!r)}function Bt(t){if(!t)return null;let e=["price","priceSALE","price_sale","selling_price","sellingPrice","sp","discountedPrice","offerPrice","special_price"];for(let r of e)if(t[r]!==void 0&&t[r]!==null){let n=Number(t[r]);if(!Number.isNaN(n)&&n>0)return n}if(t.price_info&&t.price_info.selling){let r=Number(t.price_info.selling);if(!Number.isNaN(r)&&r>0)return r}return null}function Kt(t,e){try{let r=e.pincode;if(!r)return"NO_ADDRESS_MATCH";let n=t.filter(s=>s.postalCode===r&&s.isEnabled);if(n.length===0)return"NO_ADDRESS_MATCH";if(n.length===1)return n[0].addressId;let l=new Set(["in","for","and","a","the","pg","|",",","near","opp","opposite","road","layout"]),o=e.address.toLowerCase().split(/[\s,\|]+/).map(s=>s.trim()).filter(s=>s.length>2&&!l.has(s)),d={addressId:null,score:-1};try{for(let s of n){let a=(s.label+" "+s.addressLine1+" "+s.addressLine2).toLowerCase(),u=0;s.isDefault&&(u+=10);for(let c of o)a.includes(c)&&u++;u>d.score&&(d={addressId:s.addressId,score:u})}}catch{}return d.addressId}catch{}}let $t={blinkit:"blinkit",zepto:"zepto",instamart:"instamart",amazon:"amazon_fresh",amazon_fresh:"amazon_fresh",flipkart:"flipkart_minutes",flipkart_minutes:"flipkart_minutes",bbnow:"bigbasket",bigbasket:"bigbasket",dmart:"dmart",jiomart:"jiomart"};async function jt(t){try{let r=(await chrome.storage.local.get("userLocation")).userLocation;if(!r){T("ETA_DELIVERY_TIME_ERROR",{platform:t,error:"Location not set"});return}switch(t){case"blinkit":await qe(r);break;case"instamart":await Be(r);break;case"dmart":await $e(r);break;case"flipkart_minutes":await je(r);break;case"jiomart":await Ve(r);break;case"zepto":await xe(r);break;case"amazon_fresh":await Ge(r);break;default:return}Pe(A),T("ETA_DELIVERY_TIME",A)}catch(e){T("ETA_DELIVERY_TIME_ERROR",{platform:t,error:e.message})}}async function Vt(t){try{let r=(await chrome.storage.local.get("userLocation")).userLocation;if(!r){T("ETA_DELIVERY_TIME_ERROR",{platform:t,error:"Location not set"});return}switch(t){case"bigbasket":await Ke(r);break;default:return}Pe(A),T("ETA_DELIVERY_TIME",A)}catch(e){T("ETA_DELIVERY_TIME_ERROR",{platform:t,error:e.message})}}function xt(t,e,r={}){if(!Array.isArray(t))return[];let n=[];for(let l=0;l<t.length;l++){let i=t[l];if(!i||typeof i!="object")continue;let o=ut(r[l]||r[String(l)]||1),d=(e==null?void 0:e[l])??null;if(!d){let g=-1;for(let m in i){if(m==="_clusterMeta")continue;let f=i[m];Array.isArray(f)&&f.length>g&&(g=f.length,d=m)}}let s=g=>{let m={};(g||[]).forEach(b=>{let y=q((b==null?void 0:b.source)||(b==null?void 0:b.platform));if(!y)return;let p=_e(b),h=ve(b);m[y]||(m[y]=[]),m[y].push({platform:y,product:b,price:p,available:h,qty:o})});let f=[];return Object.entries(m).forEach(([b,y])=>{let p=null,h=null;for(let _=0;_<y.length;_++){let E=y[_],U=E.price;!Number.isFinite(U)||U<=0||(E.available?(!p||U<p.price)&&(p=E):(!h||U<h.price)&&(h=E))}let v=p||h;v&&f.push(v)}),f},a=[];if(d&&Array.isArray(i[d])&&(a=s(i[d])),!a||!a.length){let g=[];for(let m in i)m!=="_clusterMeta"&&Array.isArray(i[m])&&g.push(...i[m]);a=s(g)}let u=(a||[]).filter(g=>g.available&&Number.isFinite(g.price)&&g.price>0),c=null;u.length&&(u.sort((g,m)=>g.price-m.price),c={product:u[0].product,price:u[0].price,platform:u[0].platform}),a&&a.length&&n.push({clusterId:l,variantKey:d,options:a,qty:o,cheapestAvailable:c})}return n}function oe(t){t.grandTotal=0,t.invalidMOV=!1;for(let[e,r]of Object.entries(t.platforms||{})){let n=me(e),l=Number(r.subtotal||0),i=Q.calcTotals(n,l);r.subtotal=l,r.charges=i.charges,r.total=l+i.charges.totalCharges,t.grandTotal+=r.total;let o=Q.validateMOV(n,l);r.minimumOrder=o,o&&o.valid===!1&&(t.invalidMOV=!0)}}function Gt(t,e,r){var s,a;let n=me(t),l=e[t]||0,i=((s=Q.calcFees(n,l))==null?void 0:s.totalCharges)||0,o=((a=Q.calcFees(n,l+r))==null?void 0:a.totalCharges)||0,d=Math.max(0,o-i);return r+d}function Qe(t){let e={},r={type:"best-price",name:"Lowest Price",icon:"ðŸ’°",platforms:{},items:[],totalItems:t.length,availableItems:0};for(let n of t){let l=(n.options||[]).filter(g=>Number.isFinite(g.price));if(l.length===0)continue;let i=l.filter(g=>g.available),o=i.length?i:l,d=null,s=1/0;for(let g of o){let m=ut(g.qty),f=g.price*m,b=Gt(g.platform,e,f);b<s&&(d=g,s=b)}if(!d)continue;let a=d.platform;r.platforms[a]||(r.platforms[a]={items:[],subtotal:0});let u=d.qty,c=d.price*u;r.platforms[a].items.push({clusterId:n.clusterId,variantKey:n.variantKey,product:d.product,price:d.price,qty:u,lineTotal:c,available:d.available}),r.platforms[a].subtotal+=c,e[a]=(e[a]||0)+c,d.available&&r.availableItems++,r.items.push({clusterId:n.clusterId,variantKey:n.variantKey,platform:a,price:d.price,qty:u,lineTotal:c})}return oe(r),r}function Ht(t){let e=Object.entries(t.platforms).map(([u,c])=>({platformSlug:u,subtotal:c.subtotal}));e.sort((u,c)=>u.subtotal-c.subtotal);let r=e[0];if(!r)return!1;let n=null,l=1/0;for(let u of e.slice(1)){let g=t.platforms[r.platformSlug].subtotal,m=t.platforms[u.platformSlug].subtotal,f=Q.calcFees(me(r.platformSlug),g).totalCharges,b=Q.calcFees(me(u.platformSlug),m).totalCharges,y=m+g,p=Q.calcFees(me(r.platformSlug),0).totalCharges,v=Q.calcFees(me(u.platformSlug),y).totalCharges+p-(b+f);v<l&&(l=v,n=u.platformSlug)}if(!n)return!1;let i=r.platformSlug,o=n,d=t.platforms[i],s=t.platforms[o],a=d.items||[];for(let u of a)u.product&&(u.product={...u.product,source:o,platform:o,requireReplacement:!0,dummyForPlatform:o,isEstimatedPrice:!0}),s.items.push(u);return s.subtotal+=d.subtotal,delete t.platforms[i],Array.isArray(t.items)&&t.items.forEach(u=>{u.platform===i&&(u.platform=o)}),oe(t),!0}function ge(t){return JSON.parse(JSON.stringify(t))}function we(t){return Object.keys((t==null?void 0:t.platforms)||{}).length}function Yt(t){let e=[],r=ge(t);for(oe(r),e.push(ge(r));we(r)>1&&Ht(r);)oe(r),e.push(ge(r));return e}function Je(t,e){let r=we(t),n=Number((t.grandTotal||0).toFixed(2)),l=e.reduce((d,s)=>{let a=Number(s||0);return a>d?a:d},0),i=Number((l||n).toFixed(2)),o=Math.max(0,i-n);return{platformCount:r,platforms:ge(t.platforms||{}),grandTotal:n,savings:o,isRecommended:!1,totalItems:t.totalItems,availableItems:t.availableItems,invalidMOV:!!t.invalidMOV}}function Zt(t,e,r){let n=Yt(t);oe(e);let l=[e.grandTotal,r.grandTotal,...n.map(a=>a.grandTotal)];n.sort((a,u)=>we(a)-we(u));let i=[];i.push(Je(e,l));for(let a of n){if(we(a)<=1)continue;let c=Je(a,l),g=i[i.length-1];if(c.grandTotal<g.grandTotal-1e-6)i.push(c);else break}i.some(a=>!a.invalidMOV)&&(i=i.filter(a=>!a.invalidMOV));let d=0,s=1/0;return i.forEach((a,u)=>{a.grandTotal<s-1e-6&&(s=a.grandTotal,d=u)}),i.forEach((a,u)=>a.isRecommended=u===d),{options:i,cheapestIndex:d}}function We(t){var d,s,a,u;let e=["blinkit","instamart","bigbasket","flipkart","amazon","zepto","jiomart","dmart"],r=null,n=t.length,l=Math.ceil(n/2);for(let c of e){let g=t.reduce((_,E)=>{let U=E.options.find(Z=>Z.platform===c&&Z.available);return _+(U?U.price:0)},0),m=t.reduce((_,E)=>_+(E.options.some(U=>U.platform===c&&U.available)?1:0),0);if(m<l)continue;let f=me(c),b=Q.calcTotals(f,g),y=g+(((d=b==null?void 0:b.charges)==null?void 0:d.totalCharges)||0),p=Q.getPriority(f),h=Q.validateMOV(f,g),v={plat:c,subtotal:g,grand:y,availableItems:m,priority:p,validMOV:h?h.valid:!0};if(!r)r=v;else{let _=!!r.validMOV,E=!!v.validMOV;(E&&!_||E===_&&(v.availableItems>r.availableItems||v.availableItems===r.availableItems&&(v.grand<r.grand||v.grand===r.grand&&v.priority<r.priority)))&&(r=v)}}let i={type:"single-platform",name:"Single Platform",icon:"ðŸŽ¯",platforms:{},items:[],totalItems:t.length,availableItems:0};if(!r)return i;let o=r.plat;i.platforms[o]={items:[],subtotal:0};for(let c of t){let g=c.options.find(f=>f.platform===o&&f.available),m=c.options.find(f=>f.platform===o);if(g||m){let f=g||m,b=c.qty||f.qty||1,y=f.price*b;i.platforms[o].items.push({clusterId:c.clusterId,variantKey:c.variantKey,product:f.product,price:f.price,qty:b,lineTotal:y,available:f.available}),i.platforms[o].subtotal+=y,f.available&&i.availableItems++,i.items.push({clusterId:c.clusterId,variantKey:c.variantKey,platform:o,price:f.price,qty:b,lineTotal:y})}else{let f=((s=c.cheapestAvailable)==null?void 0:s.product)||{},b=Number((a=c.cheapestAvailable)==null?void 0:a.price)||0,y={...f,pid:(f==null?void 0:f.pid)||`${o}:${c.clusterId}:placeholder`,price:b,oos:1,dummyForPlatform:o,requireReplacement:!0,isEstimatedPrice:b>0,placeholderFrom:{platform:((u=c.cheapestAvailable)==null?void 0:u.platform)||(f==null?void 0:f.source)||null,pid:(f==null?void 0:f.pid)||null,reason:"cluster-min-estimate"},actualName:f.actualName||f.productName||f.name||"",brand:f.brand||f.brandName||"",variant:f.variant||f.size||f.weight||"",source:o},p=c.qty||1,h=b*p;i.platforms[o].items.push({clusterId:c.clusterId,variantKey:c.variantKey,product:y,price:b,qty:p,lineTotal:h,available:!1}),i.platforms[o].subtotal+=h,i.items.push({clusterId:c.clusterId,variantKey:c.variantKey,platform:o,price:b,qty:p,lineTotal:h,requireReplacement:!0})}}return oe(i),i}function Qt(t,e){var c,g,m;let r={};Object.entries(e||{}).forEach(([f,b])=>{let y=q(f);r[y]=qt(b==null?void 0:b.eta)});let n=["blinkit","instamart","bigbasket","flipkart","amazon","zepto","jiomart","dmart"],l=t.length,i=Math.ceil(l/2),o={},d={};for(let f of n){let b=0,y=0;for(let p of t){let h=(p.options||[]).find(v=>v.platform===f&&v.available);h&&(b+=h.price,y++)}o[f]=b,d[f]=y}let s=n.map(f=>{let b=o[f]||0,y=d[f]||0,p=me(f),h=Q.validateMOV(p,b);return{p:f,eta:r[f]??1/0,prio:Q.getPriority(p),validMOV:h?h.valid:!0,availableItems:y}}).filter(f=>f.availableItems>=i).sort((f,b)=>f.eta-b.eta||f.prio-b.prio),a=null;for(let f of s)if(f.validMOV){a=f.p;break}!a&&s.length>0&&(a=s[0].p);let u={type:"fastest-delivery",name:"Fastest Delivery",icon:"âš¡",platforms:{},items:[],totalItems:t.length,availableItems:0};if(!a)return u;u.platforms[a]={items:[],subtotal:0};for(let f of t){let b=f.options.find(p=>p.platform===a&&p.available),y=f.options.find(p=>p.platform===a);if(b||y){let p=b||y,h=f.qty||p.qty||1,v=p.price*h;u.platforms[a].items.push({clusterId:f.clusterId,variantKey:f.variantKey,product:p.product,price:p.price,qty:h,lineTotal:v,available:p.available}),u.platforms[a].subtotal+=v,p.available&&u.availableItems++,u.items.push({clusterId:f.clusterId,variantKey:f.variantKey,platform:a,price:p.price,qty:h,lineTotal:v})}else{let p=((c=f.cheapestAvailable)==null?void 0:c.product)||{},h=Number((g=f.cheapestAvailable)==null?void 0:g.price)||0,v={...p,pid:(p==null?void 0:p.pid)||`${a}:${f.clusterId}:placeholder`,price:h,oos:1,dummyForPlatform:a,requireReplacement:!0,isEstimatedPrice:h>0,placeholderFrom:{platform:((m=f.cheapestAvailable)==null?void 0:m.platform)||(p==null?void 0:p.source)||null,pid:(p==null?void 0:p.pid)||null,reason:"cluster-min-estimate"},actualName:p.actualName||p.productName||p.name||"",brand:p.brand||p.brandName||"",variant:p.variant||p.size||p.weight||"",source:a},_=f.qty||1,E=h*_;u.platforms[a].items.push({clusterId:f.clusterId,variantKey:f.variantKey,product:v,price:h,qty:_,lineTotal:E,available:!1}),u.platforms[a].subtotal+=E,u.items.push({clusterId:f.clusterId,variantKey:f.variantKey,platform:a,price:h,qty:_,lineTotal:E,requireReplacement:!0})}}return oe(u),u}function ft(t){let e=new Map;for(let r of t)e.set(r.clusterId,r.options);return e}function dt(t,e){if(!(t!=null&&t.platforms))return{changed:!1};let r=!1;for(let[n,l]of Object.entries(t.platforms)){let i=l.items||[];for(let o=0;o<i.length;o++){let d=i[o],s=d.product,a=_e(s);if(!(!Number.isFinite(a)||a<=0||!ve(s)))continue;let g=(e.get(d.clusterId)||[]).filter(m=>m.platform===n&&m.available&&Number.isFinite(m.price));if(g.length>0){let m=g.sort((p,h)=>p.price-h.price)[0],f=(d==null?void 0:d.qty)||1,b=Number.isFinite(d.price)?d.price*f:0,y=m.price*f;l.subtotal=(l.subtotal||0)-b+y,i[o]={clusterId:d.clusterId,product:m.product,price:m.price,qty:f,lineTotal:y,available:!0},r=!0}}}return r&&oe(t),{changed:r}}function Jt(t){let e={},r={},n={};function l(i,o,d,s){let a=!!i&&String(i).trim().length>0,u=o!=null&&Number.isFinite(Number(o));if(!a||!u)return;e[i]||(e[i]=[]),e[i].includes(o)||e[i].push(o),r[i]=r[i]||d||{};let c=`${i}|${o}`;n[c]||(n[c]=[]),n[c].push(s)}return t.forEach(({id:i,cart:o})=>{for(let[d,s]of Object.entries(o.platforms||{}))(s.items||[]).forEach((a,u)=>{let c=a.product||{};if(!((c==null?void 0:c.dummyForPlatform)||Ie(a==null?void 0:a.price)||!ve(c)))return;let m=(c==null?void 0:c.pid)||(c==null?void 0:c.productId)||(c==null?void 0:c.id),f=(c==null?void 0:c.actualName)||(c==null?void 0:c.productName)||(c==null?void 0:c.name)||"",b=(c==null?void 0:c.brand)||(c==null?void 0:c.brandName)||"",y=(c==null?void 0:c.variant)||(c==null?void 0:c.size)||(c==null?void 0:c.weight)||"",p=aa(c.source),h=q((c==null?void 0:c.dummyForPlatform)||d),v=Te[h],_=typeof v=="number"?v:null,E={name:f,brand:b,size:y,pos:p,missingSlug:h,targetPos:_,searchKey:c==null?void 0:c.searchKey};l(m||`${i}:${a.clusterId}`,_,E,{cartId:i,plat:d,clusterId:a.clusterId,itemIndex:u})})}),{request:e,context:r,backrefs:n}}async function Wt({request:t,context:e}){let r=`findSimilar_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,n=`findSimilarBulk_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{let o=await B({action:"findSimilarBulk",payload:{request:t,context:e},requestId:n});if(!(o!=null&&o.success)||!o.data||!o.data.data||Object.keys(o.data.data).length===0)return{};let d=!1;for(let[s,a]of Object.entries(o.data.data)){for(let[u,c]of Object.entries(a||{}))if(Array.isArray(c)&&c.length>0){d=!0;break}if(d)break}if(!d)return{};if(d){let s=o.data.data||{},a={};return Object.entries(s).forEach(([u,c])=>{a[u]||(a[u]={}),Object.entries(c||{}).forEach(([g,m])=>{let f=Number(g),b=Ue[String(f)]||"unknown",y=Array.isArray(m)?m:[],p=b;y.length>0&&y[0].source&&(p=q(y[0].source)||b),a[u][p]=y.map(h=>{let v=typeof h.similarityScore=="number"?h.similarityScore:0,_=q(h.source||p)||p;return{...h,pid:h.pid,platform:p,source:_,title:h.productName||h.prod||h.title||h.name,brand:h.brand,size:h.variant,variant:h.variant,imageUrl:h.imageUrl,prodUrl:h.prodUrl||h.productUrl||h.url,normalized_variant:h.normalized_variant,price:h.price,mrp:h.mrp,matchScore:v,similarityScore:v,pos:f,platformPos:f}})})}),a}}catch{}let l={},i=Object.entries(t);return await Promise.all(i.map(async([o,d])=>{var a;l[o]=l[o]||{};let s=((a=e==null?void 0:e[o])==null?void 0:a.pos)??null;!Number.isFinite(s)||s===null||await Promise.all(d.map(async u=>{var g,m,f,b;let c=Ue[String(u)]||"unknown";try{let y=new Promise((v,_)=>setTimeout(()=>_(new Error(`Timeout after 2s for ${o} -> ${c}`)),2e3)),p=await Promise.race([B({action:"findSimilar",pid:o,missingPlatforms:[u],sourcePlatformPos:s,requestId:r}),y]),h=p!=null&&p.success?((m=(g=p==null?void 0:p.data)==null?void 0:g.similarProducts)==null?void 0:m[String(u)])||((b=(f=p==null?void 0:p.data)==null?void 0:f.similarProducts)==null?void 0:b[u])||[]:[];l[o][c]=h.map(v=>{let _=typeof v.similarityScore=="number"?v.similarityScore:0;return{...v,pid:v.pid,platform:c,source:v.source||c,title:v.productName||v.prod||v.title||v.name,brand:v.brand,size:v.variant,variant:v.variant,imageUrl:v.imageUrl,prodUrl:v.prodUrl||v.productUrl||v.url,normalized_variant:v.normalized_variant,price:v.price,mrp:v.mrp,matchScore:_,similarityScore:_,pos:u,platformPos:u}})}catch{l[o][c]=[]}}))})),l}function Xt(t){let e=[];for(let r of Object.keys(t||{})){let n=t[r]||{};for(let l of Object.keys(n)){let i=Array.isArray(n[l])?n[l]:[],o=q(l),d=i.map(s=>{let a=q(s.platform||s.source||l),u=typeof s.matchScore=="number"?s.matchScore:typeof s.similarityScore=="number"?s.similarityScore:0;return{...s,platform:a,source:a,title:s.title||s.productName||s.prod||s.name,size:s.size||s.variant,matchScore:u,similarityScore:u,pos:s.pos??s.platformPos??null}}).filter(s=>{if(q(s.platform||s.source)!==o){let u=s.prodUrl||s.productUrl||s.url||"";return!!(u&&(o==="flipkart"&&u.includes("flipkart.com")||o==="flipkart_minutes"&&u.includes("flipkart.com")||o==="bigbasket"&&u.includes("bigbasket.com")||o==="blinkit"&&(u.includes("blinkit.com")||u.includes("grofers.com"))||o==="instamart"&&(u.includes("swiggy.com")||u.includes("instamart"))||o==="dmart"&&u.includes("dmart.in")||o==="zepto"&&u.includes("zepto.com")||o==="amazon"&&(u.includes("amazon.in")||u.includes("amazon.com"))||o==="jiomart"&&u.includes("jiomart.com")))}return!0});e.push({basePid:r,platform:o,candidates:d})}}return e}async function Xe(t){let e=new Map,r=30,n=30,l=[],i=new Set;(t||[]).forEach(({pid:d,platform:s,variant:a})=>{if(!d||!s)return;let u=q(s),c=`${d}|${u}`;i.has(c)||(i.add(c),l.push({pid:d,platform:s,variant:a}))});let o=[];for(let d=0;d<l.length;d+=n){let s=l.slice(d,d+n),a=(async()=>{for(let u=0;u<s.length;u+=r){let c=s.slice(u,u+r);await Promise.allSettled(c.map(async({pid:g,platform:m,variant:f})=>{try{let b=await B({action:"fetchPrice",pid:g,platform:m,variant:f||1}),y=b==null?void 0:b.data;Array.isArray(y)&&(y=y[0]),y&&e.set(`${g}|${q(m)}`,y)}catch{}}))}})();o.push(a)}return await Promise.all(o),e}async function et(t,e,r){let n=ft(e),l=new Set,i=new Map;(e||[]).forEach(C=>{let I=(C.options||[]).filter(O=>O.available&&Number.isFinite(O.price)&&O.price>0);I.length&&(I.sort((O,M)=>O.price-M.price),i.set(C.clusterId,{price:I[0].price,product:I[0].product,platform:I[0].platform}))}),t.forEach(({cart:C})=>dt(C,n));let{request:o,context:d}=Jt(t);if(!(Object.keys(o).length>0))return{replacements:{},alternatives:{}};let a=[];Object.entries(o).forEach(([C,I])=>{I.forEach(O=>{let M=Ue[String(O)]||"unknown";a.push({basePid:C,platform:M})})});let u=await Wt({request:o,context:d}),c=Xt(u),g=a.filter(({basePid:C,platform:I})=>!c.some(O=>O.basePid===C&&q(O.platform)===I)),m=[];c.forEach(({candidates:C})=>{C.forEach(I=>{m.push({pid:I.pid,platform:I.platform})})});let f=await Xe(m),b=new Map,y=Date.now();c.forEach(({basePid:C,platform:I,candidates:O})=>{let M=q(I),F=`${C}|${M}`,G=[],j=O.filter(R=>{let S=q(R.platform||R.source);return!(S!==M&&!(S==="flipkart"&&M==="flipkart_minutes")&&!(S==="flipkart_minutes"&&M==="flipkart"))});j.forEach(R=>{let S=f.get(`${R.pid}|${M}`),k=ue(S==null?void 0:S.price),z=Number.isFinite(k)&&k>0&&(S==null?void 0:S.oos)!==1&&!(S!=null&&S.discontinued);G.push({cand:R,price:k,mrp:ue(S==null?void 0:S.mrp),ok:z})}),G.sort((R,S)=>R.price-S.price||S.cand.matchScore-R.cand.matchScore);let L=G.find(R=>R.ok&&R.cand.matchScore>=r)||null,J=G.slice(0,3);b.set(F,{best:L,alts_strict:J});let se=j.map(R=>{let S=f.get(`${R.pid}|${M}`),k=ue(S==null?void 0:S.price)||R.price||0,z=ue(S==null?void 0:S.mrp)||R.mrp||0;return{pid:R.pid,productName:R.title||R.productName||R.name,brand:R.brand,variant:R.variant||R.size,price:k,mrp:z,imageUrl:R.imageUrl,prodUrl:R.prodUrl||R.productUrl||R.url,matchScore:R.matchScore||R.similarityScore||0,platform:M,merchantId:R.merchantId,storeId:R.storeId,itemId:R.itemId}});if(se.length>0){let R=d==null?void 0:d[C],S={candidates:se,timestamp:y,basePid:C,platform:M,contextName:(R==null?void 0:R.name)||null,contextBrand:(R==null?void 0:R.brand)||null};ie.set(F,S),M==="flipkart"?ie.set(`${C}|flipkart_minutes`,S):M==="flipkart_minutes"&&ie.set(`${C}|flipkart`,S);let k=new Map,z=((R==null?void 0:R.name)||"").toLowerCase().trim(),w=((R==null?void 0:R.brand)||"").toLowerCase().trim();t.forEach(({cart:le})=>{for(let[ae,x]of Object.entries(le.platforms||{}))(x.items||[]).forEach(ce=>{let P=ce.product||{},$=(P==null?void 0:P.pid)||(P==null?void 0:P.productId)||(P==null?void 0:P.id),W=q((P==null?void 0:P.source)||(P==null?void 0:P.platform)||ae),fe=((P==null?void 0:P.actualName)||(P==null?void 0:P.productName)||(P==null?void 0:P.name)||"").toLowerCase().trim(),ne=((P==null?void 0:P.brand)||(P==null?void 0:P.brandName)||"").toLowerCase().trim(),H=!1;if($===C)H=!0;else if(z&&fe&&w&&ne){let V=z===fe||z.includes(fe)||fe.includes(z),Y=w===ne||w.includes(ne)||ne.includes(w);H=V&&Y}H&&$&&W&&(k.has(W)||k.set(W,[]),k.get(W).push($))})}),k.forEach((le,ae)=>{le.forEach(x=>{let ce=`${x}|${M}`;ie.set(ce,S),M==="flipkart"?ie.set(`${x}|flipkart_minutes`,S):M==="flipkart_minutes"&&ie.set(`${x}|flipkart`,S)})})}});let p=[...c.map(({basePid:C,platform:I})=>({basePid:C,platform:I})),...g],h=new Map,v=new Map;t.forEach(({cart:C})=>{for(let[I,O]of Object.entries(C.platforms||{}))(O.items||[]).forEach(M=>{let F=M.product||{},G=(F==null?void 0:F.pid)||(F==null?void 0:F.productId)||(F==null?void 0:F.id);G&&!v.has(G)&&v.set(G,{searchKey:F.searchKey,name:F.standardized_name||F.actualName||F.productName||F.name,brand:F.brand||F.brandName,size:F.normalized_variant?`${F.normalized_variant.quantity} ${F.normalized_variant.unit}`:F.selectedVariant||F.variant||F.size})})});let _=30;for(let C=0;C<p.length;C+=_){let I=p.slice(C,C+_);await Promise.allSettled(I.map(async({basePid:O,platform:M})=>{let F=new Promise((G,j)=>setTimeout(()=>j(new Error(`Timeout for ${O}|${M}`)),4e3));try{await Promise.race([(async()=>{let G=`${O}|${M}`,j=d==null?void 0:d[O],L=v.get(O);if(j){let P={name:(L==null?void 0:L.name)||j.name,brand:(L==null?void 0:L.brand)||j.brand,size:(L==null?void 0:L.size)||j.size,searchKey:(L==null?void 0:L.searchKey)||j.searchKey},{candidates:$,alternativeKey:W}=await ke(P,M,5,!0,{alternativeKey:G,failedPlatforms:l});h.set(G,$||[])}else h.set(G,[]);if(!j)return;let J=b.get(G);if(!(!(J==null?void 0:J.best)||J.best.cand.matchScore<r))return;let S={name:(L==null?void 0:L.name)||j.name,brand:(L==null?void 0:L.brand)||j.brand,size:(L==null?void 0:L.size)||j.size,searchKey:(L==null?void 0:L.searchKey)||j.searchKey},{candidates:k}=await ke(S,M,3,!1,{failedPlatforms:l});if(!k||!k.length)return;let z=k.map(P=>({pid:P.pid,platform:M})),w=await Xe(z),le=k.map(P=>{let $=w.get(`${P.pid}|${M}`),W=ue($==null?void 0:$.price),fe=Number.isFinite(W)&&W>0&&($==null?void 0:$.oos)!==1&&!($!=null&&$.discontinued);return{cand:P,price:W,mrp:ue($==null?void 0:$.mrp),ok:fe}}).filter(P=>Number.isFinite(P.price));le.sort((P,$)=>P.price-$.price||$.cand.matchScore-P.cand.matchScore);let x=le.find(P=>P.ok&&P.cand.matchScore>=r)||null||(J==null?void 0:J.best)||null,ce=((J==null?void 0:J.alts_strict)||[]).concat(le).slice(0,3);b.set(G,{best:x,alts_strict:ce})})(),F])}catch{}}))}let E=(C=[])=>C.map(I=>{let O=I.normalized_variant?`${I.normalized_variant.quantity} ${I.normalized_variant.unit}`:I.size||I.variant||null,M=q(I.platform||I.source);return{...I,pid:I.pid,platform:M||I.platform,source:M||I.source||I.platform,productName:I.productName||I.title||I.name,brand:I.brand||null,variant:O,selectedVariant:O,imageUrl:I.imageUrl||I.image||null,prodUrl:I.prodUrl||I.productUrl||I.url||null,normalized_variant:I.normalized_variant||null,platformPos:I.pos??I.platformPos??null,price:_e(I),mrp:ue(I.mrp),matchScore:I.matchScore,available:ve(I)}}),U=new Map,Z={},K={};return t.forEach(({id:C,cart:I})=>{var O,M,F,G,j,L,J;Z[C]=[],K[C]=[];for(let[se,R]of Object.entries(I.platforms||{})){let S=R.items||[];for(let k=0;k<S.length;k++){let z=S[k],w=z.product||{};if(!((w==null?void 0:w.dummyForPlatform)||Ie(z==null?void 0:z.price)||!ve(w)))continue;let ae=(w==null?void 0:w.pid)||(w==null?void 0:w.productId)||(w==null?void 0:w.id);if(!ae&&d){let H=w==null?void 0:w.searchKey,V=(w==null?void 0:w.standardized_name)||(w==null?void 0:w.actualName)||(w==null?void 0:w.productName)||(w==null?void 0:w.name);for(let[Y,X]of Object.entries(d)){if(H&&X.searchKey===H){ae=Y;break}if(V&&X.name&&V.toLowerCase().trim()===X.name.toLowerCase().trim()){ae=Y;break}}}ae||(ae=`${C}:${z.clusterId}`);let x=q((w==null?void 0:w.dummyForPlatform)||se);if(l&&l.has(x)){S[k].product={...w,requireReplacement:!0,alternatives:[],alternativeCandidates:[]};continue}let ce=`${ae}|${x}`,P=h.get(ce)||[],$=b.get(ce);if((!P||P.length===0)&&(!$||!$.best)){let H=`${z.clusterId}|${x}`,V=h.get(H),Y=b.get(H);V&&V.length>0&&(P=V),Y&&($=Y)}let W;if(U.has(ce)?W=ge(U.get(ce)):(W=E(P).map(V=>{let Y=q(V.source||V.platform);if(!Y||Y!==x){let X=V.prodUrl||V.productUrl||V.url||"";if(X){let te=null;X.includes("bigbasket.com")?te="bigbasket":X.includes("flipkart.com")?te="flipkart":X.includes("blinkit.com")||X.includes("grofers.com")?te="blinkit":X.includes("swiggy.com")||X.includes("instamart")?te="instamart":X.includes("dmart.in")?te="dmart":X.includes("zepto.com")?te="zepto":X.includes("amazon.in")||X.includes("amazon.com")?te="amazon":X.includes("jiomart.com")&&(te="jiomart"),te&&(te===x||x==="flipkart_minutes"&&te==="flipkart")&&(Y=te)}}return{...V,platform:Y||x,source:Y||x}}).filter(V=>{let Y=q(V.source||V.platform);return!(Y!==x&&!(Y==="flipkart"&&x==="flipkart_minutes")&&!(Y==="flipkart_minutes"&&x==="flipkart"))}),U.set(ce,ge(W))),(O=$==null?void 0:$.best)!=null&&O.ok){let H=$.best,V=f.get(`${H.cand.pid}|${x}`)||{},Y={...w.cartMeta||{},platform:x,itemId:V.itemId||V.listingId||((M=w.cartMeta)==null?void 0:M.itemId)||w.itemId,spinId:V.spinId||((F=w.cartMeta)==null?void 0:F.spinId)||w.spinId,offerId:V.offerId||((G=w.cartMeta)==null?void 0:G.offerId)||w.offerId,quantity:(z==null?void 0:z.qty)||((j=w.cartMeta)==null?void 0:j.quantity)||1,raw:V.raw||V||((L=w.cartMeta)==null?void 0:L.raw)},X={...w,pid:H.cand.pid,brand:H.cand.brand||w.brand,variant:H.cand.size||w.variant,price:H.price,oos:0,discontinued:!1,source:x,platform:x,cartMeta:Y,itemId:Y.itemId,spinId:Y.spinId,offerId:Y.offerId},te=(z==null?void 0:z.qty)||1,ht=Number.isFinite(z.price)?z.price*te:0,He=H.price*te;R.subtotal=(R.subtotal||0)-ht+He,S[k]={clusterId:z.clusterId,variantKey:z.variantKey,product:{...X,autoReplaced:!0,replacementMeta:{fromPid:ae,matchScore:H.cand.matchScore,method:w!=null&&w.dummyForPlatform?"dummy-findSimilar":"findSimilar"},alternatives:W,alternativeCandidates:W},price:H.price,qty:te,lineTotal:He,available:!0},Z[C].push({reason:w!=null&&w.dummyForPlatform?"dummy-findSimilar":"findSimilar",clusterId:z.clusterId,from:ae,to:H.cand.pid,platform:x,matchScore:H.cand.matchScore});continue}let fe={clusterId:z.clusterId,platform:x,pid:ae,title:(w==null?void 0:w.actualName)||(w==null?void 0:w.productName)||"",alternatives:W};K[C].push(fe),S[k].product={...w,requireReplacement:!0,alternativeCandidates:W,alternatives:W};let ne=i.get(z.clusterId);if((!Number.isFinite(z.price)||z.price<=0)&&(ne==null?void 0:ne.price)>0){let H=(z==null?void 0:z.qty)||1,V=Number.isFinite(z.price)?z.price*H:0;S[k].price=ne.price,S[k].lineTotal=ne.price*H,R.subtotal=(R.subtotal||0)-V+S[k].lineTotal,S[k].product.isEstimatedPrice=!0,S[k].product.placeholderFrom={platform:ne.platform,pid:(J=ne.product)==null?void 0:J.pid,reason:"cluster-min-estimate"}}}}oe(I)}),{replacements:Z,alternatives:K}}let tt={blinkit:"fetchBlinkitSearch",instamart:"fetchInstamartSearch","swiggy instamart":"fetchInstamartSearch",swiggyinstamart:"fetchInstamartSearch",bigbasket:"fetchBigBasketSearch","big basket":"fetchBigBasketSearch",bb:"fetchBigBasketSearch",bbnow:"fetchBigBasketSearch",flipkart:"fetchFlipkartMinutes",fk:"fetchFlipkartMinutes","flipkart minutes":"fetchFlipkartMinutes",flipkartminutes:"fetchFlipkartMinutes",flipkart_minutes:"fetchFlipkartMinutes",amazon:"fetchAmazonSearch",amz:"fetchAmazonSearch","amazon fresh":"fetchAmazonSearch",amazon_fresh:"fetchAmazonSearch","amazon prime now":"fetchAmazonSearch",amazonnow:"fetchAmazonSearch",jiomart:"fetchJioMartSearch","jio mart":"fetchJioMartSearch",dmart:"fetchDMartSearch",zepto:"fetchZeptoSearch"};function at(t){if(!t)return null;let e=String(t).toLowerCase(),r=e.match(/(\d+(?:\.\d+)?)\s*[xÃ—]\s*(\d+(?:\.\d+)?)\s*(ml|l|ltr|litre|kg|g|pcs?|pieces?|pack)/i);if(r){let o=parseFloat(r[1]),d=parseFloat(r[2]),s=r[3].toLowerCase();return rt(o*d,s)}let n=e.match(/(\d+(?:\.\d+)?)\s*(ml|l|ltr|litre|kg|g|pcs?|pieces?|piece|pack)\b/i);if(!n)return null;let l=parseFloat(n[1]),i=n[2].toLowerCase();return rt(l,i)}function rt(t,e){return e==="ltr"||e==="l"||e==="litre"?(e="ml",t*=1e3):e==="kg"?(e="g",t*=1e3):e.startsWith("pc")||e.startsWith("piece")?e="pc":e==="pack"&&(e="pack"),{unit:e,qty:t}}function ea(t,e){let r=at(t),n=at(e);if(!r||!n||r.unit!==n.unit)return 0;let l=Math.abs(r.qty-n.qty),i=Math.max(r.qty,n.qty);if(l===0)return 1;let o=l/i;return Math.max(0,1-o)}function Ee(t){return String(t||"").toLowerCase().replace(/[^a-z0-9]+/g," ").trim()}function ta(t,e){let r=Ee(t.name||""),n=Ee(e.productName||e.prod||e.title||""),l=new Set(r.split(/\s+/).filter(Boolean)),i=new Set(n.split(/\s+/).filter(Boolean)),o=[...l].filter(f=>i.has(f)).length,d=l.size?o/l.size:0,s=(()=>{if(!t.brand||!e.brand)return 0;let f=Ee(t.brand),b=Ee(e.brand);return f===b?1:0})(),a=ea(t.size,e.variant||e.size),u=!!t.size,c=.5,g=.2,m=u?.3:.1;return c*d+g*s+m*a}function aa(t){let e=q(t);return e&&Te.hasOwnProperty(e)?Te[e]:null}let ra=["Fruits","Vegetables","Fruits and Vegetables","Fresh","N/A (No brand visible in image)","Unbranded","unbranded","UNBRANDED","null","Null","NULL"];function la(t){if(!t)return"";let e=t.trim();return ra.includes(e)?"":e}function ia(t){let e=t||{},r=la(e.brand||e.brandName),n=e.standardized_name||e.actualName||e.name||e.productName||"",l=e.normalized_variant?`${e.normalized_variant.quantity} ${e.normalized_variant.unit}`:e.selectedVariant||e.variant||e.size||"",i="",o=String(n).toLowerCase(),d=String(r).toLowerCase(),s=String(l).toLowerCase();return i=n,r&&!o.includes(d)&&(i=`${r} ${i}`),l&&!o.includes(s)&&(i=`${i} ${l}`),i=i.replace(/\bunbranded\b/gi,"").replace(/\bnull\b/gi,"").replace(/\s+/g," ").trim(),i}async function ke({name:t,brand:e,size:r,searchKey:n},l,i=6,o=!1,d={}){let{alternativeKey:s,disableCache:a,failedPlatforms:u}=d||{},c=(l||"").toString().toLowerCase(),g=q(l)||c;if(u&&u.has(g))return{candidates:[],alternativeKey:null};let m=tt[g]||tt[c];if(!m)return{candidates:[],alternativeKey:null};let f,b;n?(f=n,b=encodeURIComponent(n)):(f=ia({name:t,brand:e,size:r}),b=encodeURIComponent(f));let y=`${g}|${n||f}|${i}|${o?"1":"0"}`,p=Date.now(),h=!a;h&&ye.size>30&&st();let v=h?ye.get(y):null;if(v&&p-v.ts<it){let _=s||`alt_${p}_${Math.random().toString(36).substr(2,5)}`;return{candidates:v.candidates,alternativeKey:_}}try{let _=s||`alt_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,E=await B({action:m,query:f,searchQuery:b,latitude:D==null?void 0:D.latitude,longitude:D==null?void 0:D.longitude,isNewSearch:!1,onlyForSuggestion:!0,sessionRequestId:_,alternativeKey:s}),U=!0;if((g==="instamart"||g==="swiggy")&&((E==null?void 0:E.statusCode)===400||(E==null?void 0:E.status)===400)&&(U=!1),!E||E.success===!1||E.statusCode&&E.statusCode!==200||E.status&&E.status!==200&&E.status!==void 0)return u&&U&&u.add(g),{candidates:[],alternativeKey:null};if(E.alternativeKey!==_)return{candidates:[],alternativeKey:null};let K=(Array.isArray(E==null?void 0:E.clusters)?E.clusters:[]).flatMap(S=>Object.entries(S).filter(([k])=>k!=="_clusterMeta").flatMap(([,k])=>Array.isArray(k)?k:[])),C=[];K.length>0&&(C=K.slice(0,3).map(S=>({...S,platform:q(S.source||S.platform)||g,source:q(S.source||S.platform)||g,isTopApiResult:!0})));let I=K.filter(S=>{let k=q(S.source||S.platform);return!(!k||k!==g)}),O=!1;if(n){let S=n.toLowerCase();O=["fresh","fresho","vegetable","fruit","leaves","herbs","greens","coriander","spinach","onion","tomato","potato","carrot","cabbage","cauliflower"].some(z=>S.includes(z))||!e||e.length<3}let M=I.filter(S=>{if(n){let k=n.toLowerCase().split(/\s+/).filter(z=>z.length>2);if(k.length>0){let z=(S.productName||S.name||S.title||"").toLowerCase();if(O){if(k.filter(le=>z.includes(le)).length===0)return!1}else{let w=k.filter(ae=>z.includes(ae)).length,le=Math.max(Math.ceil(k.length*.3),Math.min(2,k.length));if(w<le)return!1}}}return!0}),F=new Set,G=[];if(M.forEach(S=>{S.pid&&!F.has(S.pid)&&(F.add(S.pid),G.push(S))}),C.forEach(S=>{q(S.source||S.platform)===g&&S.pid&&!F.has(S.pid)&&(F.add(S.pid),G.push(S))}),M=G,o){let S=[],k=[];M.forEach(w=>{q(w.source||w.platform)===g&&(w.isTopApiResult?k.push(w):S.push(w))});let z=[...S,...k].slice(0,i).map(w=>({...w,platform:g,source:g,matchScore:w.isTopApiResult?.9:1,selectedVariant:w.variant||w.size||null}));return h&&ye.set(y,{ts:p,candidates:z}),{candidates:z,alternativeKey:E.alternativeKey}}let j=[],L=[];M.forEach(S=>{q(S.source||S.platform)===g&&(S.isTopApiResult?L.push(S):j.push(S))});let J=j.map(S=>{let k=ta({name:t,brand:e,size:r},S);return{...S,platform:g,source:g,matchScore:k,selectedVariant:S.variant||S.size||null}}).sort((S,k)=>k.matchScore-S.matchScore),se=L.map(S=>({...S,platform:g,source:g,matchScore:.5,selectedVariant:S.variant||S.size||null})),R=[...J,...se].slice(0,i);return h&&ye.set(y,{ts:p,candidates:R}),{candidates:R,alternativeKey:E.alternativeKey}}catch{return u&&g!=="instamart"&&g!=="swiggy"&&u.add(g),{candidates:[],alternativeKey:null}}}async function sa(t){let e=[],r=new Set;for(let n of t)if(n)for(let l of Object.values(n.platforms||{}))for(let i of l.items||[]){let o=i.product;o!=null&&o.requireReplacement&&(!o.alternatives||o.alternatives.length===0)&&e.push(i)}e.length!==0&&await Promise.allSettled(e.map(async n=>{try{let l=n.product,i=q(l.platform||l.dummyForPlatform);if(!i||r.has(i))return;let o={name:l.standardized_name||l.actualName||l.name,brand:l.brand||null,size:l.normalized_variant?`${l.normalized_variant.quantity} ${l.normalized_variant.unit}`:l.selectedVariant||l.variant,searchKey:l.searchKey},d=l.pid||l.id||`cluster:${n.clusterId}`,s=`${i}|${d}|${n.clusterId}`,{candidates:a,alternativeKey:u}=await ke(o,i,5,!0,{alternativeKey:s,failedPlatforms:r});u===s&&a&&a.length>0&&(l.alternatives=a,l.alternativeCandidates=a)}catch{}}))}function na(t){let e={carts:{},meta:t.meta||{},deliveryTimeReported:Fe||{}},r=t.carts.find(i=>i.id==="price-optimized"),n=t.carts.find(i=>i.id==="fastest-delivery"),l=t.carts.find(i=>i.id==="single-platform");if(n){let i=[],o={};Object.entries(n.platforms||{}).forEach(([d,s])=>{let u=(s.items||[]).map(Le);o[d]={products:u,replacements:u.filter(c=>c.requireReplacement),charges:s.charges||{},minimumOrder:s.minimumOrder||null,subtotal:s.subtotal||0,total:s.total||0},i.push(...u)}),e.carts.fast_Delivery={max_platforms:1,products:i,platforms:o,meta:{id:n.id,type:n.type,name:n.name,icon:n.icon,grandTotal:n.grandTotal,invalidMOV:n.invalidMOV,totalItems:n.totalItems,availableItems:n.availableItems}}}if(r&&r.options){let i={max_platforms:r.options.length,meta:{selectedOption:r.selectedOption,cheapestOption:r.cheapestOption}};r.options.forEach((o,d)=>{let s=`platform_${d+1}`,a={};Object.entries(o.platforms||{}).forEach(([u,c])=>{let m=(c.items||[]).map(Le);a[u]={products:m,replacements:m.filter(f=>f.requireReplacement),charges:c.charges||{},minimumOrder:c.minimumOrder||null,subtotal:c.subtotal||0,total:c.total||0}}),i[s]=a,i[s].meta={platformCount:o.platformCount,grandTotal:o.grandTotal,savings:o.savings,isRecommended:o.isRecommended,invalidMOV:o.invalidMOV,totalItems:o.totalItems,availableItems:o.availableItems}}),e.carts.best_Price=i}if(l){let i=[],o={};Object.entries(l.platforms||{}).forEach(([d,s])=>{let u=(s.items||[]).map(Le);o[d]={products:u,replacements:u.filter(c=>c.requireReplacement),charges:s.charges||{},minimumOrder:s.minimumOrder||null,subtotal:s.subtotal||0,total:s.total||0},i.push(...u)}),e.carts.best_Available={max_platforms:1,products:i,platforms:o,meta:{id:l.id,type:l.type,name:l.name,icon:l.icon,grandTotal:l.grandTotal,invalidMOV:l.invalidMOV,totalItems:l.totalItems,availableItems:l.availableItems}}}return e}function Le(t){let e=t.product||{},r=Number.isFinite(t.price)?t.price:null,n=_e(e),l=ve(e);return{id:e.pid,clusterId:t.clusterId,platform:e.source||e.platform,name:e.actualName||e.productName||e.prod||e.name,brand:e.brand||null,image:e.imageUrl||e.image||e.thumbnail,productUrl:e.productUrl||e.prodUrl||e.url,price:r??n,mrp:e.mrp||null,qty:t.qty||1,selectedVariant:t.variantKey||null,variant:e.variant||e.size||null,available:l,requireReplacement:!!e.requireReplacement,isEstimatedPrice:!!e.isEstimatedPrice,autoReplaced:!!e.autoReplaced,replacementMeta:e.replacementMeta||null,alternatives:e.alternativeCandidates||e.alternatives||[],itemId:e.itemId||null,spinId:e.spinId||null,offerId:e.offerId||null,ocrText:e.ocrText||null,normalized_variant:e.normalized_variant||null,cartMeta:e.cartMeta||null}}async function oa({clusters:t,deliveryTime:e={},selectedVariants:r={},quantityByCluster:n={}}){let l=Q.ensureLoaded(),i=xt(t,r,n);await l;let o=Q.getAutoReplacementThreshold(),d=Qe(i),s=We(i),a=Qt(i,e),u=[{id:"price-optimized",cart:d},{id:"single-platform",cart:s},{id:"fastest-delivery",cart:a}],{replacements:c,alternatives:g}=await et(u,i,o);oe(a);let m=ca(i,u),f=Qe(m),b=We(m),y=[{id:"price-optimized",cart:f},{id:"single-platform",cart:b}],p=ft(m);y.forEach(({cart:U})=>dt(U,p)),oe(f),oe(b),await et([{id:"price-optimized-v2",cart:f},{id:"single-platform-v2",cart:b}],m,o);let{options:v,cheapestIndex:_}=Zt(f,b,a),E=v[_];return Q.platformConfig("blinkit"),{carts:[{id:"price-optimized",type:"best-price",name:"Lowest Price",icon:"ðŸ’°",platforms:ge(E.platforms),grandTotal:E.grandTotal,invalidMOV:E.invalidMOV,totalItems:E.totalItems,availableItems:E.availableItems,options:v,selectedOption:_,cheapestOption:_},{id:"single-platform",...b},{id:"fastest-delivery",...a}],replacements:c,alternatives:g,meta:{configVersion:Q!=null&&Q.platformConfig("blinkit")&&Q.getAutoReplacementThreshold?"config":"fallback",autoReplacementThreshold:o,totalClusters:i.length,generatedAt:Date.now(),quantityByCluster:n}}}function ca(t,e){let r;typeof structuredClone=="function"?r=structuredClone(t||[]):r=JSON.parse(JSON.stringify(t||[]));let n=new Map;for(let{cart:l}of e)for(let i of Object.values(l.platforms||{}))for(let o of i.items||[])if(o.product&&(o.product.autoReplaced||o.available)){let d=`${o.clusterId}|${o.product.platform}|${o.product.pid}`;n.has(d)||n.set(d,{clusterId:o.clusterId,product:o.product,price:o.price,available:o.available,platform:o.product.platform,qty:o.qty||1})}return n.forEach(l=>{let i=r.find(o=>o.clusterId===l.clusterId);i&&(i.options.some(d=>d.product.pid===l.product.pid&&d.platform===l.platform)||i.options.push({platform:l.platform,product:l.product,price:l.price,available:l.available,qty:l.qty}))}),r}let be=null,De=!1;async function ua(t={}){if(!!!t.force&&De&&be)return be;try{let r=await ee({type:"getDeliveryConfig"});if(r&&r.platforms)return be=r,De=!0,be;throw new Error("Failed to load valid delivery config. Response invalid.")}catch(r){throw r}}function mt(){if(!De||!be)throw new Error("Delivery config not loaded. Call and await loadDeliveryConfig() first.");return be}function Oe(t){var r;return((r=mt().platforms)==null?void 0:r[t])||null}function fa(t){let e=Oe(t);return(e==null?void 0:e.priority)??999}function da(t,e,r){switch(r){case">":return t>e;case">=":return t>=e;case"<":return t<e;case"<=":return t<=e;case"==":case"===":return t===e;default:return!1}}function pt(t,e){var c;let r=Oe(t);if(!(r!=null&&r.charges))return{deliveryFee:0,handlingFee:0,smallCartFee:0,gst:0,totalCharges:0,breakdown:[]};let n=r.charges,l=[],i=0,o=0,d=0,s=0,a=(g,m)=>{if(!g)return 0;if(g.waiverCondition){let f=da(e,g.waiverCondition.threshold,g.waiverCondition.operator),b=f?g.waivedAmount||0:g.amount||0;return l.push({type:m,amount:b,waived:f,description:g.description}),b}if(g.mandatory){let f=g.amount||0;return l.push({type:m,amount:f,waived:!1,description:g.description}),f}return 0};i=a(n.deliveryFee,"deliveryFee"),o=a(n.handlingFee,"handlingFee"),d=a(n.smallCartFee,"smallCartFee"),(c=n.gst)!=null&&c.mandatory&&(s=n.gst.amount||0,l.push({type:"gst",amount:s,waived:!1,description:n.gst.description}));let u=i+o+d+s;return{deliveryFee:i,handlingFee:o,smallCartFee:d,gst:s,totalCharges:u,breakdown:l}}function ma(t,e){let r=pt(t,e);return{cfgSlug:t,cartSubtotal:e,charges:r,grandTotal:e+r.totalCharges}}function pa(t,e){let r=Oe(t),n=(r==null?void 0:r.minimumOrderValue)||0,l=e>=n;return{valid:l,minimumOrderValue:n,shortfall:l?0:n-e}}function ha(){let t=mt();return typeof t.autoReplacementThreshold=="number"?t.autoReplacementThreshold:.9}let Q={ensureLoaded:ua,platformConfig:Oe,getPriority:fa,calcFees:pt,calcTotals:ma,validateMOV:pa,getAutoReplacementThreshold:ha},ga={blinkit:"https://blinkit.com/?cart",instamart:"https://www.swiggy.com/instamart/cart",swiggy:"https://www.swiggy.com/instamart/cart",zepto:"https://www.zepto.com/?cart=open",dmart:"https://www.dmart.in/cart",bigbasket:"https://www.bigbasket.com/basket/",bbnow:"https://www.bigbasket.com/basket/",jiomart:"https://www.jiomart.com/checkout/cart",amazon:"https://www.amazon.in/gp/cart/view.html?ref_=nav_cart",amazon_fresh:"https://www.amazon.in/gp/cart/view.html?ref_=nav_cart",amazonnow:"https://www.amazon.in/gp/cart/view.html?ref_=nav_cart",flipkart:"https://www.flipkart.com/viewcart?marketplace=HYPERLOCAL",flipkart_minutes:"https://www.flipkart.com/viewcart?marketplace=HYPERLOCAL"},ya={blinkit:"https://blinkit.com/account/orders",instamart:"https://www.swiggy.com/auth?prevPath=https://www.swiggy.com/instamart",swiggy:"https://www.swiggy.com/auth?prevPath=https://www.swiggy.com/instamart",zepto:"https://www.zepto.com/",dmart:"https://www.dmart.in/",bigbasket:"https://www.dmart.in/",bbnow:"https://www.dmart.in/",jiomart:"https://www.jiomart.com/customer/account/login",amazon:"https://www.amazon.in/your-orders/orders",amazonnow:"https://www.amazon.in/your-orders/orders",flipkart:"https://www.flipkart.com/account/login?ret=/",flipkart_minutes:"https://www.flipkart.com/account/login?ret=/"},ba=chrome.runtime.connect({name:"ATC_PROGRESS_PORT"});ba.onMessage.addListener(t=>{try{(t==null?void 0:t.type)==="ADD_TO_CART_ITEM_PROGRESS"&&t.payload&&T("ADD_TO_CART_ITEM_RESULT",t.payload)}catch{}});window.addEventListener("FROM_PAGE_REQUEST",async t=>{var n,l,i,o,d;let{type:e,payload:r}=t.detail;if(e==="SEARCH_PRODUCT"){let s=r.query;lt=s,N=`search_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,await ee({type:"getPlatformSearchConfig"}),chrome.storage.local.get(["platformConnections"],a=>{var c,g,m,f,b,y,p,h;let u=a.platformConnections||Ae;(c=u.Blinkit)!=null&&c.connected&&It(s,0,!1,N,!0),(g=u["Flipkart Minutes"])!=null&&g.connected&&Et(s,N,!1),(m=u.Zepto)!=null&&m.connected&&At(s,N,!1),(f=u.BigBasket)!=null&&f.connected&&wt(s,N,!1),(b=u.Amazon)!=null&&b.connected&&Ct(s,N,!1),(y=u.JioMart)!=null&&y.connected&&_t(s,N,!1),(p=u.DMart)!=null&&p.connected&&Rt(s,N,!1),(h=u.Instamart)!=null&&h.connected&&Tt(s,N,!1)})}else if(e==="GET_SUGGESTIONS")await ee({type:"getAllGroceryConfig",data:{}}),Pt(r.query);else if(e==="REQUEST_LOCATION")kt(r);else if(e==="REQUEST_LOCATION_MANUAL")Ot(r.query);else if(e==="FETCH_DELIVERY_TIMES")Se();else if(e==="REQUEST_ETA_TIME")Se(!1,!0);else if(e==="SELECT_ADDRESS")Mt(r.address);else if(e==="REFETCH_PRICE")Re(r);else if(e==="VARIENT_CHANGE")Re(r);else if(e.startsWith("REFETCH_ETA_TIME_"))try{let s=e.replace("REFETCH_ETA_TIME_","").toLowerCase(),a=$t[s];if(!a)return;if(!(await chrome.storage.local.get("userLocation")).userLocation){T("ETA_DELIVERY_TIME_ERROR",{platform:a,error:"Location not set"});return}await jt(a)}catch{}else if(e=="REFETCH_BBNOW_ETA")try{let s="bigbasket";if(!(await chrome.storage.local.get("userLocation")).userLocation){T("ETA_DELIVERY_TIME_ERROR",{platform:s,error:"Location not set"});return}await Vt(s)}catch{}else if(e=="AMAZON_ADDRESS_SELECTED"){let s=(n=r==null?void 0:r.address)==null?void 0:n.addressId;if(s){let a=await ct(s);a?A.amazon={eta:a,connected:!0}:A.amazon={eta:null,connected:!1},T("ETA_DELIVERY_TIME",A)}}else if(e=="CHECKOUT_TO_SMART_CART")try{let s=r||{},a=[];Array.isArray(s.cart)?a=s.cart:Array.isArray(s.clusters)?a=s.clusters:Array.isArray(s)&&s.every(v=>v.product)&&(a=s);let u=s.deliveryTimes?Promise.resolve(s.deliveryTimes):Se(!0),c=s.selectedVariants||{},g=s.quantities||{},m=a.map((v,_)=>{let E=v.selectedVariants||"default",U=v.quantities||1,K=(v.product||[]).map(I=>{if(!I)return I;let O=q(I.source||I.platform||I.platformName);return{...I,source:O,platform:O}}),C={[E]:K,_clusterMeta:{defaultVariant:E,defaultQty:U}};return c[_]=E,g[_]=U,C});if(!Array.isArray(m)||m.length===0){T("TOP3_CARTS",null,"No valid clusters provided after mapping.");return}Fe=await u||{};let f=await oa({clusters:m,deliveryTime:Fe||{},selectedVariants:c||{},quantityByCluster:g||{}});await sa(f.carts);let y=na(f),p={success:!0},h=(l=y==null?void 0:y.carts)==null?void 0:l.best_Price;if(h&&h.meta){let v=h.meta.cheapestOption;if(typeof v=="number"){let _=`platform_${v+1}`,E=h[_];if(E&&E.meta){let U=E.meta;p.maxSaving=U.savings,p.totalCartAmount=U.grandTotal,p.productsCount=U.totalItems}}}await ee({type:"fireEvent",eventName:"grocerySmartCartCreated",params:p}),T("TOP3_CARTS",y)}catch(s){await ee({type:"fireEvent",eventName:"grocerySmartCartCreated",params:{success:!1}}),T("TOP3_CARTS",null,(s==null?void 0:s.message)||"Failed to compute Top 3 carts")}else if(e==="REQUEST_ALTERNATIVE")try{let{selectedFilter:s,replacementObject:a,platformName:u,replacementArrayIndex:c}=r;if(!a||!u||c===void 0)throw new Error(`Invalid payload for REQUEST_ALTERNATIVE: ${JSON.stringify(r)}`);let m=((i=a.replacementMeta)==null?void 0:i.fromPid)||a.pid||a.id||a.productId,f=q(u),b=m?`${m}|${f}`:null,y=[],p=`manual|${u}|${c}`,h=p,v=!1;if(b&&m){let U=Date.now();ie.size>25&&nt();let Z=ie.get(b);if(!Z&&(f==="flipkart"||f==="flipkart_minutes")){let K=f==="flipkart"?`${m}|flipkart_minutes`:`${m}|flipkart`;Z=ie.get(K)}if(!Z){for(let[K,C]of ie.entries())if(K.startsWith(`${m}|`)&&U-C.timestamp<Ce){let I=K.split("|")[1];if(q(I)===f){Z=C;break}}}if(!Z&&a.name&&a.brand){let K=(a.name||"").toLowerCase().trim(),C=(a.brand||"").toLowerCase().trim(),I=O=>O?O.replace(/\s+/g," ").trim():"";C=I(C);for(let[O,M]of ie.entries())if(U-M.timestamp<Ce){let F=O.split("|")[1];if(q(F)===f){let G=M.basePid,j=(M.contextName||"").toLowerCase().trim(),L=I((M.contextBrand||"").toLowerCase());if(j||L){let J=j===K||j&&K&&(j.includes(K)||K.includes(j)),se=L===C||C&&L&&(L.includes(C)||C.includes(L))||!C&&!L;if(J&&se){Z=M;break}}if(!Z&&M.candidates&&M.candidates.length>0&&M.candidates.find(se=>{let R=(se.productName||"").toLowerCase().trim(),S=I((se.brand||"").toLowerCase()),k=R===K||R.includes(K)||K.includes(R),z=S===C||C&&S&&(S.includes(C)||C.includes(S))||!C&&!S;return k&&z})){Z=M;break}}}}Z&&U-Z.timestamp<Ce&&(y=(Z.candidates||[]).filter(K=>{if(q(K.platform||K.source)!==f){let I=K.prodUrl||K.productUrl||K.url||"";return!!(I&&(f==="bigbasket"&&I.includes("bigbasket.com")||f==="flipkart"&&I.includes("flipkart.com")||f==="blinkit"&&(I.includes("blinkit.com")||I.includes("grofers.com"))||f==="instamart"&&(I.includes("swiggy.com")||I.includes("instamart"))||f==="dmart"&&I.includes("dmart.in")||f==="zepto"&&I.includes("zepto.com")||f==="amazon"&&(I.includes("amazon.in")||I.includes("amazon.com"))||f==="jiomart"&&I.includes("jiomart.com")))}return!0}),v=!0)}if(!v){let U={name:a.standardized_name||a.actualName||a.name,brand:a.brand||null,size:a.normalized_variant?`${a.normalized_variant.quantity} ${a.normalized_variant.unit}`:a.selectedVariant||a.variant,searchKey:a.searchKey},K=await ke(U,f,5,!0,{alternativeKey:p,disableCache:!0,failedPlatforms:new Set});if(y=(K.candidates||[]).filter(C=>{if(q(C.platform||C.source)!==f){let O=C.prodUrl||C.productUrl||C.url||"";return!!(O&&(f==="bigbasket"&&O.includes("bigbasket.com")||f==="flipkart"&&O.includes("flipkart.com")||f==="blinkit"&&(O.includes("blinkit.com")||O.includes("grofers.com"))||f==="instamart"&&(O.includes("swiggy.com")||O.includes("instamart"))||f==="dmart"&&O.includes("dmart.in")||f==="zepto"&&O.includes("zepto.com")||f==="amazon"&&(O.includes("amazon.in")||O.includes("amazon.com"))||f==="jiomart"&&O.includes("jiomart.com")))}return!0}),h=K.alternativeKey||p,h!==p){T("ALTERNATIVE_RESULT",{[c]:[]},"Failed to fetch alternatives (key mismatch)");return}}let _={...a,alternatives:y};T("ALTERNATIVE_RESULT",{selectedFilter:s,platformName:u,replacementArrayIndex:c,replacementObject:_})}catch(s){let a=r&&r.replacementArrayIndex!==void 0?r.replacementArrayIndex:"general_error";T("ALTERNATIVE_RESULT",{[a]:[]},(s==null?void 0:s.message)||"Failed to fetch alternatives")}else if(e==="REQUEST_ADD_TO_CART_URL")try{let s=r||{},{platformName:a,products:u=[]}=s;if(!a||!Array.isArray(u))throw new Error("Invalid payload: platformName and products[] are required");let c=String(a).toLowerCase(),g=ga[c]||null,m=ya[c]||null,f;if(c==="blinkit"){let y=await B({action:"AddToCartHelper",product:u,platform:"blinkit"}),p=null;if(y){let h=y;p={deepLink:h.deeplinkUrl||((o=h==null?void 0:h.data)==null?void 0:o.deeplinkUrl)||null,message:h.message||null,itemsCount:h.itemsCount||0,totalItems:h.totalItems||0}}f={success:(y==null?void 0:y.success)??!1,platform:a,blinkit:y,blinkitDeepLink:p}}else if(c==="instamart"){let y=[],p=!0;try{const h=[],v=[];for(let _ of u)if(_.spinId)h.push(_);else{const E={success:!1,product:_,error:"Missing required field (spinId)",message:"Failed to add product to cart"};v.push(E),y.push(E),p=!1,T("ADD_TO_CART_ITEM_RESULT",{platform:a,result:E})}if(h.length===0)f={success:!1,platform:a,cartUrl:g,loginUrl:m,results:y,message:"No valid products to add"};else{const _=await B({action:"AddToCartHelper",product:h,platform:a});if(_!=null&&_.results&&Array.isArray(_.results))for(let E of _.results)y.push(E),E.success||(p=!1),T("ADD_TO_CART_ITEM_RESULT",{platform:a,result:E});else for(let E of h){const U={success:_.success,product:E,error:_.error,message:_.message};y.push(U),U.success||(p=!1),T("ADD_TO_CART_ITEM_RESULT",{platform:a,result:U})}f={success:p,platform:a,cartUrl:g,loginUrl:m,results:y,allItemsAdded:_.allItemsAdded,addedCount:_.addedCount,totalRequested:_.totalRequested,message:_.message,retryCount:_.retryCount,data:_.data}}}catch(h){p=!1,y=u.map(v=>({success:!1,product:v,error:(h==null?void 0:h.message)||"Unknown error occurred",message:"Failed to add product to cart"}));for(let v of y)T("ADD_TO_CART_ITEM_RESULT",{platform:a,result:v});f={success:!1,platform:a,cartUrl:g,loginUrl:m,error:(h==null?void 0:h.message)||"Unknown error occurred",message:"Failed to add products to cart",results:y}}}else if(c==="dmart"){let y=!1,p=[];try{let h=await B({action:"AddToCartHelper",product:u,platform:a});y=!!(h!=null&&h.success),p=u.map(v=>({...h,product:v})),h.success}catch(h){y=!1,p=u.map(v=>({success:!1,product:v,error:(h==null?void 0:h.message)||"Unknown error occurred",message:"Failed to add product to cart"}))}f={success:y,platform:a,cartUrl:g,loginUrl:m,results:p}}else if(c==="flipkart_minutes"||c==="flipkart"){let y=!0;try{let p=await B({action:"AddToCartHelper",product:u,platform:a});y=p.success,p.success,f={success:y,platform:a,cartUrl:g,loginUrl:m,results:p.results}}catch(p){f={success:!1,platform:a,error:(p==null?void 0:p.message)||"Unknown error occurred",message:"Failed to add products to Flipkart cart"}}}else if(c==="zepto")try{let y=await B({action:"AddToCartHelper",product:u,platform:"zepto"}),p=Array.isArray(y)?y:[y];f={success:p.length>0&&p.every(v=>v&&v.success),platform:a,cartUrl:g,loginUrl:m,results:p}}catch(y){f={success:!1,platform:a,error:(y==null?void 0:y.message)||"Failed to initiate Zepto queue"}}else{let y=await Promise.all(u.map(async h=>{try{let _={...await B({action:"AddToCartHelper",product:h,platform:a}),product:h};return T("ADD_TO_CART_ITEM_RESULT",{platform:a,result:_}),_}catch(v){let _={success:!1,product:h,error:(v==null?void 0:v.message)||"Unknown error occurred",message:"Failed to add product to cart"};return T("ADD_TO_CART_ITEM_RESULT",{platform:a,result:_}),_}}));f={success:y.length>0&&y.every(h=>h&&h.success),platform:a,cartUrl:g,loginUrl:m,results:y}}let b=0;Array.isArray(u)&&(b=u.reduce((y,p)=>{if(!p||typeof p!="object")return y;let h=p.price??p.finalPrice??p.offerPrice??0,v=p.quantity??1;return h=Number(h)||0,v=Number(v)||1,y+h*v},0)),await ee({type:"fireEvent",eventName:"groceryAddedToCart",params:{success:!0,groceryStore:a,itemCount:u.length,totalAmount:b}}),T("ADD_TO_CART_RESULT",f)}catch(s){await ee({type:"fireEvent",eventName:"groceryAddedToCart",params:{success:!1}}),T("ADD_TO_CART_RESULT",null,(s==null?void 0:s.message)||"Failed to add products to cart")}else if(e==="IS_EXTENSION_INSTALLED"){let s=1,a=await chrome.storage.local.get("platformConnections"),u=await chrome.storage.local.get("userLocation");(((d=Object.keys((a==null?void 0:a.platformConnections)??{}))==null?void 0:d.length)==0||!(u!=null&&u.userLocation))&&(s=2),T("EXTENSION_INSTALL_CHECK",{status:s})}else if(e=="GROCERY_PRODUCT_CLICKED"){let{pid:s,pos:a,url:u}=r;await ee({type:"fireEvent",eventName:"groceryProductClicked",params:{pid:s,pos:a,url:u}})}else if(e=="GROCERY_CART_CLICKED"){let{itemCount:s}=r;await ee({type:"fireEvent",eventName:"groceryCartClicked",params:{itemCount:s}})}else if(e=="GROCERY_SORT_BY_PRICE_CLICKED"){let{totalPrice:s,totalItemCount:a}=r;await ee({type:"fireEvent",eventName:"grocerySortByPriceClicked",params:{totalPrice:s,totalItemCount:a}})}else if(e=="GROCERY_SORT_BY_AVAILABILITY_CLICKED"){let{totalPrice:s,totalItemCount:a,platformPos:u}=r;await ee({type:"fireEvent",eventName:"grocerySortByAvailabilityClicked",params:{totalPrice:s,totalItemCount:a,platformPos:u}})}else if(e=="GROCERY_SORT_BY_DELIVERY_TIME_CLICKED"){let{totalPrice:s,totalItemCount:a,platformPos:u}=r;await ee({type:"fireEvent",eventName:"grocerySortByDeliveryTimeClicked",params:{totalPrice:s,totalItemCount:a,platformPos:u}})}else if(e=="SEND_ANALYTICS_EVENT"){let{eventName:s,params:a}=r;await ee({type:"fireEvent",eventName:s,params:a||{}})}});chrome.runtime.onMessage.addListener((t,e,r)=>{if(t.action==="callAPIFromDOM")return(async()=>{var n;try{if((n=t==null?void 0:t.data)!=null&&n.eachUrl){let l=await fetch(t.data.eachUrl,t.data.eachOptions);if(l.status>=300){r({success:!1,result:{status:l.status}});return}let i=await l.text();r({success:!0,result:{result:i,status:l.status}})}}catch(l){r({success:!1,result:{status:400},error:l.message})}})(),!0});
